---
title: "Goshawk"
author: "Amanda Emmel"
date: "2025-01-20"
output: html_document
---
```{r install}
library(dplyr)
library(ggplot2)
require(AICcmodavg);  require(gclus);  require(SASmixed)
library(Matrix)
library(lme4)
library(lmerTest)
library(tidyr)
library(AICcmodavg)
gos <- read.csv("goshawk_lures.csv")
```

Format variables
```{r class}
gos$Cover <- as.factor(gos$Cover)
gos$Ground <- as.factor(gos$Ground)
gos$Lure <- as.factor(gos$Lure)
gos$ID <- as.factor(gos$ID)
gos$Motion <- as.factor(gos$Motion)
gos$Rep <- as.factor(gos$Rep)
class(gos$Cover)
class(gos$Ground)
class(gos$Lure)
class(gos$ID)
class(gos$Motion)
class(gos$Order)
gos$color <- paste(gos$Lure, gos$Ground)
```

Subsetting data by experiment type
```{r subsets}
move <- filter(gos, Motion=='M')
still <- filter(gos, Motion=='S')
open <- filter(gos, Cover=='O')
forest <- filter(gos, Cover=='F')
mopen <- filter(open, Motion=='M')
sopen <- filter(open, Motion=='S')
mforest <- filter(forest, Motion=='M')
sforest <- filter(forest, Motion=='S')

#Visiualizing data distribution and calculating mean values
hist(move$Dist)
mean(move$Dist, na.rm=TRUE)
hist(still$Dist)
mean(still$Dist)
mean(mforest$Dist, na.rm=TRUE)
mean(mean(mopen$Dist, na.rm=TRUE))
```
Checking that the repetition at each site (once per lure color) doesn't affect attack distance
```{r}
summary(rep <- lmer(Dist~Rep + (Order|ID), data=move))

summary(glm(Dist ~ Rep, data=move))

ggplot(move, aes(x=Rep, y=Dist, color=ID)) + geom_boxplot()

#doesn't look like an issue
```


    _______________RESEARCH QUESTION_________________
How does camouflage mismatch impact raptorsâ€™ ability to recognize and pursue prey?

  H1: Raptors will be more successful in recognizing mismatched targets than camouflaged targets.
    P1a: Raptors will have longer attack distances on mismatched lures compared to camouflaged lures.
    P1b: Raptors will have longer attack distances on mismatched stationary models compared to camouflaged models.
    
  H2: Raptors will be more successful in recognizing mismatched stationary models than camouflaged stationary models, but the effect of camouflage will be negligible for moving lures.
    P1a0: Attack distance will be similar for moving lures regardless of camouflage or mismatch.
    P1b: Raptors will have longer attack distances on mismatched stationary models compared to camouflaged models.

```{r H1 H2 Testing}
p1a <- lmer(Dist ~ Lure*Ground + Order + Cover + (1|ID), move)
summary(p1a)
plot(p1a)
qqnorm(resid(p1a))
confint(p1a)

p1b <- lmer(Dist ~ Lure*Ground + Order + Cover + (1|ID), still)
summary(p1b)
plot(p1b)
qqnorm(resid(p1b))
confint(p1b)
```
P1a is not supported, but P1b is, which lends support for our second hypothesis: Mismatch does matter but not when prey is moving.

```{r Calculating Predicted Attack Distances}
#Moving Lures
ordeff <- 0.17961*30
BBmf <-6.32831 + ordeff
BWmf <- BBmf +  0.32834
WBmf <- BBmf + 1.33396
WWmf <- BWmf + 1.33396 -1.90947

mopeff <- 20.06653
BBmo <- BBmf + mopeff
BWmo <- BWmf + mopeff
WBmo <- WBmf + mopeff
WWmo <- WWmf + mopeff

#Stationary Models
sordeff <- 0.08043 * 30
BBsf <- 2.39625 + sordeff
BWsf <- BBsf + -0.28112
WBsf <- BBsf + 3.00206
WWsf <- BWsf + 3.00206 - 3.07505

sopeff <- 2.85244
BBso <- BBsf + sopeff
BWso <- BWsf + sopeff
WBso <- WBsf + sopeff
WWso <- WWsf + sopeff
```
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

H3:  Increased cover in forest will ameliorate the positive effect of mismatch on raptor hunting success, given decreased visibility of prey.
	 P3a: Raptor attack distances will be longer for mismatched lures compared to camouflaged lures in open habitat.
  P3b0: Raptor attack distance will be similar between mismatched and camouflaged lures in forest.
  P3c: Raptor attack distances will be longer for mismatched models compared to camouflaged models in open habitat.
  P3d0: Attack distance will be similar between mismatched and camouflaged models in forest.

H4: Open habitats will dilute the the positive effect of mismatch on raptor hunting success, given the conspicuousness of all prey in the open.
  P3a0: Raptor attack distance will be similar between mismatched and camouflaged lures in open habitat.
  P3b: Raptor attack distances will be longer for mismatched lures compared to camouflaged lures in forest.
	P3c0: Attack distance will be similar between mismatched and camouflaged models in open habitat.
  P3d: Raptor attack distances will be longer for mismatched models compared to camouflaged models in forest.
  
```{r H3 Testing}
p3a <- lmer(Dist ~ Lure*Ground + Order + (1|ID), mopen)
summary(p3a)
plot(p3a)
qqnorm(resid(p3a))
#p3a0 Null supported. Mismatch doesn't matter for moving lures in open.

p3b <- lmer(Dist ~ Lure*Ground + Order + (1|ID), mforest)
summary(p3b)
plot(p3b)
qqnorm(resid(p3b))
#p3b0 Null supported. Mismatch doesn't matter for moving lures in forest.

p3c <- lmer(Dist ~ Lure*Ground + Order + (1|ID), sopen)
summary(p3c)
plot(p3c)
qqnorm(resid(p3c))
#p3c supported. Mismatch matters for still models in open.

p3d <- lmer(Dist ~ Lure*Ground + Order + (1|ID), sforest)
summary(p3d)
plot(p3d)
qqnorm(resid(p3d))
#p3d supported. Mismatch matters for still models in forest.

#Double checking that habitat doesn't influence effects of mismatch using a 3-way interaction.
p4a <- lmer(Dist ~ Lure*Ground*Cover + Order + (1|ID), move)
summary(p4a)

p4b <- lmer(Dist ~ Lure*Ground*Cover + Order + (1|ID), still)
summary(p4b)
```


```{r Plots Fig1}
#Plots: Fig 1 - Attack Distances by Camouflage Scenario
library(ggplot2)

move.frame <- data.frame(Color=as.factor(move$color),
                          Distance=move$Dist,
                          Cover=move$Cover,
                          Ground=move$Ground,
                          Lure=move$Lure)

plot_move <- 
  ggplot(move.frame, aes(x=Color, y = Distance, color = Ground, fill = Lure)) +
  theme_classic() + 
  geom_jitter(aes(y=move$Dist), size = 0.8, width = 0.1, alpha = 0.4) + 
  geom_boxplot() +
  facet_wrap(~Cover, labeller = labeller(Cover = c("F" = "Forest", "O" = "Open")))+
  xlab("Brown                   White                          Brown                    White") +   ylab("Attack Distance (m)") + 
  ggtitle("Attack Distances (m) of Model Prey by Mismatch Status & Habitat", "Moving Lures") +
  scale_fill_manual(values= c("#CC9966", "snow"), guide=FALSE) +
  scale_color_manual(values = c("burlywood4", "goldenrod1"), labels = c("Bare Ground", "Snow")) +
  scale_x_discrete(labels=c("Match", "Mismatch", "Mismatch", "Match"))

plot_move

still.frame <- data.frame(Color=as.factor(still$color),
                                Distance=still$Dist,
                                Cover=still$Cover,
                                Ground=still$Ground,
                                Lure=still$Lure)
plot_still <- 
  ggplot(still.frame, aes(x=Color, y = Distance, color = Ground, fill = Lure)) +
  theme_classic() + 
  geom_jitter(aes(y=still$Dist), size = 0.8, width = 0.1, alpha = 0.4) + 
  geom_boxplot() +
  facet_wrap(~Cover, labeller = labeller(Cover = c("F" = "Forest", "O" = "Open")))+
  xlab("Brown                   White                          Brown                    White") +   ylab("Attack Distance (m)") + 
  ggtitle("", "Stationary Models") +
  scale_fill_manual("Model", values= c("#CC9966", "snow"), guide=FALSE) +
  scale_color_manual(values = c("burlywood4", "goldenrod1"), labels = c("Bare Ground", "Snow")) +
  scale_x_discrete(labels=c("Match", "Mismatch", "Mismatch", "Match"))

plot_still
```

```{r Plots FigA1 }
#Figure A1: Hawk Learning over Time 
learn_mopen <- lmer(Dist ~ Lure*Ground + Order + (1|ID), mopen)
summary(learn_mopen)
confint(learn_mopen)

learn_mforest <- lmer(Dist ~ Lure*Ground + Order + (1|ID), mforest)
summary(learn_mforest)
confint(learn_mforest)

 plot_move_learn <- ggplot(move, aes(x = Order, y = Dist, group = ID, 
         color = ID, shape = Cover)) + geom_point(size=2)+ theme_classic() + xlim(0,63) +
  xlab("Consecutive Trial Number") + ylab("Attack Distance (m)") + 
  ggtitle("Goshawk Learning: Attack Distance over Time", "Moving Lures") +
  scale_color_manual(name = "Goshawk ID", values = c("#66c2a5", "#8da0cb", "#fc8d62")) + 
  scale_shape_discrete(name = "Habitat", labels = c("Forest", "Open")) + 
  geom_abline(slope = 0.28968, intercept = 22.28473, linewidth=0.5,  linetype=2, color="gray") + 
  geom_abline(slope = 0.04169, intercept = 10.98061, linewidth=0.5, linetype=1, color="gray")

plot_move_learn

#Stationary Models
learn_sopen <- lmer(Dist ~ Lure*Ground + Order + (1|ID), sopen)
summary(learn_sopen)

learn_sforest <- lmer(Dist ~ Lure*Ground + Order + (1|ID), sforest)
summary(learn_sforest)

plot_still_learn <- ggplot(still, aes(x = Order, y = Dist, group = ID, color = ID, shape = Cover)) + geom_point(size=2)+ theme_classic() + xlim(0,63) +
  xlab("Consecutive Trial Number") + ylab("Attack Distance (m)") + 
  ggtitle("", "Stationary Models") +
  scale_color_manual(name = "Goshawk ID", values = c("#66c2a5", "#8da0cb", "#fc8d62")) + 
  scale_shape_discrete(name = "Habitat", labels = c("Forest", "Open")) + 
  geom_abline(slope = 0.06919, intercept = 5.79142, linewidth=0.7, linetype=2, color="gray") +
  geom_abline(slope = 0.03924, intercept = 3.28573, linewidth=0.5, linetype=1, color="gray")
  
plot_still_learn
```

Model selection (Appendix)
```{r moving lure model selection}
 Move_models <- list()
 Move_models[[1]] <- lmer(Dist ~ Lure*Ground + Cover + (1|ID), move, REML=FALSE)
 Move_models[[2]] <- lmer(Dist ~ Lure*Ground + (1|ID), move, REML=FALSE)
 Move_models[[3]] <- lmer(Dist ~ Cover + (1|ID), move, REML=FALSE)
 Move_models[[4]] <- lmer(Dist ~ (1|ID), move, REML=FALSE)
 Move_models[[5]] <- lmer(Dist ~ Lure*Ground + Cover + Order + (1|ID), move, REML=FALSE)
 Move_models[[6]] <- lmer(Dist ~ Lure*Ground + Order + (1|ID), move, REML=FALSE)
 Move_models[[7]] <- lmer(Dist ~ Cover + Order + (1|ID), move, REML=FALSE)
 Move_models[[8]] <- lmer(Dist ~ Order + (1|ID), move, REML=FALSE)

    mov_names <- c("mov_all", "mov_mm_id", "mov_cov_id", "mov_id", "mov_all_ord",
    "mov_mm_ord_id", "mov_cov_ord_id", "mov_ord_id")
    
    aicmov<-aictab(cand.set = Move_models, modnames = mov_names, sort = TRUE)
  aicmov

#Top model of goshawk attack distance on moving lures includes habitat and learning, but not mismatch.
 summary(Move_models[[7]])
 plot(Move_models[[7]])
 qqnorm(resid((Move_models[[7]])))
```


```{r stationary model selection}
Still_models <- list()
Still_models[[1]] <- lmer(Dist ~ Lure*Ground + Cover + (1|ID), still, REML=FALSE)
Still_models[[2]] <- lmer(Dist ~ Lure*Ground + (1|ID), still, REML=FALSE)
Still_models[[3]] <- lmer(Dist ~ Cover + (1|ID), still, REML=FALSE)
Still_models[[4]] <- lmer(Dist ~ (1|ID), still, REML=FALSE)
Still_models[[5]] <- lmer(Dist ~ Lure*Ground + Cover + Order + (1|ID), still, REML=FALSE)
Still_models[[6]] <- lmer(Dist ~ Lure*Ground + Order + (1|ID), still, REML=FALSE)
Still_models[[7]] <- lmer(Dist ~ Cover + Order + (1|ID), still, REML=FALSE)
Still_models[[8]] <- lmer(Dist ~ Order + (1|ID), still, REML=FALSE)

    stil_names <- c("stil_all", "stil_mm_id",  "stil_cov_id",  "stil_id", "still_all_ord", "still_mm_ord_id", "still_cov_ord_id", "still_ord_id")
    
    aicstil<-aictab(cand.set = Still_models, modnames = stil_names, sort = TRUE)
  aicstil

#Top model of goshawk attack distance on stationary models includes all covariates: mimsmatch, habitat, and learning.
  summary(Still_models[[5]])
  plot(Still_models[[5]])
  qqnorm(resid((Still_models[[5]])))
```

Ratios of mismatched:matched attack distances at each experiment location (Appendix)
```{r mismatch ratios}
bmove <- filter(move, Ground=='B')
wmove <- filter(move, Ground=='W')
bstill <- filter(still, Ground=='B')
bstill$Dist[bstill$Dist == 0] <- NA
#bstill$Dist[bstill$Dist == 0] <- 1
wstill <- filter(still, Ground=='W')
bmf <- filter(mforest, Ground=='B')
wmf <- filter(mforest, Ground=='W')
bmo <- filter(mopen, Ground=='B')
wmo <- filter(mopen, Ground=='W')
bsf <- filter(bstill, Cover=='F')
wsf <- filter(sforest, Ground=='W')
bso <- filter(bstill, Cover=='F')
wso <- filter(sopen, Ground=='W')

camo_bmove <- subset(bmove, Lure=='B')
mism_bmove <- subset(bmove, Lure=='W')
merge_bmove <- merge(camo_bmove, mism_bmove, by='Loc', suffixes = c('_BB', '_WB'))
merge_bmove$mmRatio <- merge_bmove$Dist_WB/merge_bmove$Dist_BB
bmove_mmRatio <- mean(merge_bmove$mmRatio, na.rm=TRUE)

camo_bstill <- subset(bstill, Lure=='B')
mism_bstill <- subset(bstill, Lure=='W')
merge_bstill <- merge(camo_bstill, mism_bstill, by='Loc', suffixes = c('_BB', '_WB'))
merge_bstill$mmRatio <- merge_bstill$Dist_WB/merge_bstill$Dist_BB
bstill_mmRatio <- mean(merge_bstill$mmRatio, na.rm=TRUE)

camo_wmove <- subset(wmove, Lure=='W')
mism_wmove <- subset(wmove, Lure=='B')
merge_wmove <- merge(camo_wmove, mism_wmove, by='Loc', suffixes = c('_WW', '_BW'))
merge_wmove$mmRatio <- merge_wmove$Dist_BW/merge_wmove$Dist_WW
wmove_mmRatio <- mean(merge_wmove$mmRatio, na.rm=TRUE)

camo_wstill <- subset(wstill, Lure=='W')
mism_wstill <- subset(wstill, Lure=='B')
merge_wstill <- merge(camo_wstill, mism_wstill, by='Loc', suffixes = c('_WW', '_BW'))
merge_wstill$mmRatio <- merge_wstill$Dist_BW/merge_wstill$Dist_WW
wstill_mmRatio <- mean(merge_wstill$mmRatio, na.rm=TRUE)

camo_bmf <- subset(bmf, Lure=='B')
mism_bmf <- subset(bmf, Lure=='W')
merge_bmf <- merge(camo_bmf, mism_bmf, by='Loc', suffixes = c('_BB', '_WB'))
merge_bmf$mmRatio <- merge_bmf$Dist_WB/merge_bmf$Dist_BB
bmf_mmRatio <- mean(merge_bmf$mmRatio, na.rm=TRUE)

camo_bmo <- subset(bmo, Lure=='B')
mism_bmo <- subset(bmo, Lure=='W')
merge_bmo <- merge(camo_bmo, mism_bmo, by='Loc', suffixes = c('_BB', '_WB'))
merge_bmo$mmRatio <- merge_bmo$Dist_WB/merge_bmo$Dist_BB
bmo_mmRatio <- mean(merge_bmo$mmRatio, na.rm=TRUE)

camo_bsf <- subset(bsf, Lure=='B')
mism_bsf <- subset(bsf, Lure=='W')
merge_bsf <- merge(camo_bsf, mism_bsf, by='Loc', suffixes = c('_BB', '_WB'))
merge_bsf$mmRatio <- merge_bsf$Dist_WB/merge_bsf$Dist_BB
bsf_mmRatio <- mean(merge_bsf$mmRatio, na.rm=TRUE)

camo_bso <- subset(bso, Lure=='B')
mism_bso <- subset(bso, Lure=='W')
merge_bso <- merge(camo_bso, mism_bso, by='Loc', suffixes = c('_BB', '_WB'))
merge_bso$mmRatio <- merge_bso$Dist_WB/merge_bso$Dist_BB
bso_mmRatio <- mean(merge_bso$mmRatio, na.rm=TRUE)

camo_wmf <- subset(wmf, Lure=='W')
mism_wmf <- subset(wmf, Lure=='B')
merge_wmf <- merge(camo_wmf, mism_wmf, by='Loc', suffixes = c('_WW', '_BW'))
merge_wmf$mmRatio <- merge_wmf$Dist_BW/merge_wmf$Dist_WW
wmf_mmRatio <- mean(merge_wmf$mmRatio, na.rm=TRUE)

camo_wmo <- subset(wmo, Lure=='W')
mism_wmo <- subset(wmo, Lure=='B')
merge_wmo <- merge(camo_wmo, mism_wmo, by='Loc', suffixes = c('_WW', '_BW'))
merge_wmo$mmRatio <- merge_wmo$Dist_BW/merge_wmo$Dist_WW
wmo_mmRatio <- mean(merge_wmo$mmRatio, na.rm=TRUE)

camo_wsf <- subset(wsf, Lure=='W')
mism_wsf <- subset(wsf, Lure=='B')
merge_wsf <- merge(camo_wsf, mism_wsf, by='Loc', suffixes = c('_WW', '_BW'))
merge_wsf$mmRatio <- merge_wsf$Dist_BW/merge_wsf$Dist_WW
wsf_mmRatio <- mean(merge_wsf$mmRatio, na.rm=TRUE)

camo_wso <- subset(wso, Lure=='W')
mism_wso <- subset(wso, Lure=='B')
merge_wso <- merge(camo_wso, mism_wso, by='Loc', suffixes = c('_WW', '_BW'))
merge_wso$mmRatio <- merge_wso$Dist_BW/merge_wso$Dist_WW
wso_mmRatio <- mean(merge_wso$mmRatio, na.rm=TRUE)


mm_ratios <- c(bmove_mmRatio, bmf_mmRatio, bmo_mmRatio, wmove_mmRatio, wmf_mmRatio, wmo_mmRatio, bstill_mmRatio, bsf_mmRatio, bso_mmRatio, wstill_mmRatio, wsf_mmRatio, wso_mmRatio)
ratio_labels <- c("Bare Ground Moving", "Bare Ground Moving, Forest", "Bare Ground Moving, Open", "Snow Moving", "Snow Moving, Forest", "Snow Moving, Open", "Bare Ground Stationary", "Bare Ground Stationary, Forest", "Bare Ground Stationary, Open", "Snow Stationary", "Snow Stationary, Forest", "Snow Stationary, Open")
print(ratio_table <- data.frame(Label=ratio_labels, Value= mm_ratios))
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
